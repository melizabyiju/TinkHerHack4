<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>RiverClean ‚Äì Detect River Waste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass-panel {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 10px 40px -10px rgba(14, 165, 233, 0.15);
    }
  </style>
</head>

<body
  class="bg-gradient-to-br from-blue-50 to-teal-50 text-slate-900 min-h-screen relative flex flex-col items-center justify-center p-4">

  <!-- Decorative background elements -->
  <div class="fixed top-0 right-0 -mr-40 -mt-40 w-[500px] h-[500px] bg-blue-500/10 rounded-full blur-3xl z-[-1]"></div>
  <div class="fixed bottom-0 left-0 -ml-40 -mb-40 w-[500px] h-[500px] bg-teal-500/10 rounded-full blur-3xl z-[-1]">
  </div>

  <div class="w-full max-w-lg mb-6 flex justify-between items-center glass-panel px-6 py-4 rounded-2xl relative z-10">
    <div class="flex items-center space-x-2">
      <span class="font-bold text-slate-800">Hi, <span
          class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-teal-500">{{ username }}</span>
        üåä</span>
    </div>
    <div class="flex items-center space-x-4 text-sm font-medium">
      <a href="{{ url_for('dashboard') }}" class="text-slate-500 hover:text-blue-600 transition-colors">Dashboard</a>
      {% if is_admin %}
      <a href="{{ url_for('admin_panel') }}" class="text-indigo-500 hover:text-indigo-600 transition-colors">Admin</a>
      {% endif %}
      <a href="{{ url_for('logout') }}" class="text-red-500 hover:text-red-600 transition-colors">Logout</a>
    </div>
  </div>

  <div class="w-full max-w-lg glass-panel p-8 sm:p-10 rounded-[2.5rem] relative z-10">
    <div class="text-center mb-8">
      <div
        class="mx-auto w-16 h-16 bg-gradient-to-br from-blue-600 to-teal-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
          <polyline points="14 2 14 8 20 8" />
          <circle cx="10" cy="13" r="2" />
          <path d="m14.5 17.5-3-3" />
        </svg>
      </div>
      <h1 class="text-3xl font-extrabold text-slate-800 mb-2">Scan River</h1>
      <p class="text-slate-500 text-sm">Upload a photo. Our AI analyzes the image, logs the location, and notifies
        authorities instantly.</p>
    </div>

    <form id="uploadForm" class="space-y-6">

      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-3">Proof of Pollution</label>
        <div class="relative w-full group">
          <input type="file" id="photo" name="photo" accept="image/*" required
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
          <div id="fileBtnContainer"
            class="border-2 border-dashed border-blue-200 rounded-2xl p-8 text-center bg-blue-50/50 group-hover:bg-blue-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-blue-500 mb-3" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            <p id="fileBtnText" class="font-medium text-blue-600">Choose an Image...</p>
            <p class="text-xs text-slate-400 mt-1">PNG, JPG up to 10MB</p>
          </div>
        </div>
        <div
          class="mt-3 flex items-center justify-center text-xs font-medium text-amber-600 bg-amber-50 py-2 rounded-lg border border-amber-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <span id="locationStatus">Location Access Recommended</span>
        </div>
        <input type="hidden" id="locationData" name="location" value="">
      </div>

      <div id="imagePreview" class="hidden relative rounded-2xl overflow-hidden shadow-sm border border-slate-200">
        <img id="previewImg" src="" alt="Image Preview" class="w-full h-48 object-cover" />
      </div>

      <button type="submit" id="submitBtn"
        class="w-full flex justify-center py-4 px-4 border border-transparent text-sm font-bold rounded-xl text-white bg-gradient-to-r from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-lg hover:shadow-blue-500/30 transition-all transform hover:-translate-y-0.5 disabled:opacity-70 disabled:cursor-not-allowed">
        Analyze River Condition
      </button>
    </form>

    <div id="result" class="hidden mt-6 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm text-center"></div>

    <div class="mt-8 pt-6 border-t border-slate-100 text-center text-xs text-slate-400 font-medium">
      &copy; 2026 RiverClean &mdash; A student project for a cleaner planet üåé
    </div>
  </div>

  <script>
    const photoInput = document.getElementById('photo');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const fileBtnText = document.getElementById('fileBtnText');
    const locationData = document.getElementById('locationData');

    photoInput.addEventListener('change', function () {
      if (this.files && this.files[0]) {
        fileBtnText.innerText = '‚úÖ ' + this.files[0].name;
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImg.src = e.target.result;
          imagePreview.classList.remove('hidden');
        };
        reader.readAsDataURL(this.files[0]);
      } else {
        fileBtnText.innerText = 'Choose an Image...';
        imagePreview.classList.add('hidden');
        previewImg.src = '';
      }
    });

    const getCoordinates = () => new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        resolve("Geolocation not supported");
      } else {
        navigator.geolocation.getCurrentPosition(
          position => resolve(`${position.coords.latitude},${position.coords.longitude}`),
          err => resolve("Location access denied")
        );
      }
    });

    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const resultDiv = document.getElementById('result');
      resultDiv.classList.add('hidden');
      resultDiv.innerHTML = '';
      const photo = document.getElementById('photo').files[0];

      if (!photo) {
        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = '<span class="text-red-500 font-bold">Please select a river photo first.</span>';
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyzing Image...';

      const loc = await getCoordinates();
      locationData.value = loc;

      const formData = new FormData();
      formData.append('photo', photo);
      formData.append('location', loc);

      try {
        const resp = await fetch('/detect', { method: 'POST', body: formData });

        if (resp.status === 401) {
          window.location.href = "{{ url_for('login') }}";
          return;
        }

        if (!resp.ok) throw new Error('Server error');

        const data = await resp.json();
        let html = '';
        if (data.error) {
          html = `<span class="text-red-500 font-bold">${data.error}</span>`;
        } else {
          html += data.category === 'Polluted'
            ? `<div class="inline-flex items-center space-x-2 bg-red-50 text-red-600 px-4 py-2 rounded-full border border-red-200 font-bold mb-4"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> <span>Detected: Polluted</span></div>`
            : `<div class="inline-flex items-center space-x-2 bg-green-50 text-green-600 px-4 py-2 rounded-full border border-green-200 font-bold mb-4"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg> <span>Detected: Clean</span></div>`;

          html += `<div class="text-slate-600 text-sm flex items-center justify-center space-x-2 mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> <span>${data.location}</span></div>`;

          if (data.category === 'Polluted') {
            html += `<div class="bg-gradient-to-r from-amber-50 to-orange-50 text-orange-700 p-3 rounded-xl border border-orange-100 font-semibold text-sm mb-3">Thank you! You earned 1 RiverClean point! ‚≠ê</div>`;
          }
          if (data.authorities_notified) {
            html += `<div class="text-blue-600 font-bold text-sm bg-blue-50 p-2 rounded-lg border border-blue-100">üö® Authorities notified!</div>`;
          }
        }
        resultDiv.innerHTML = html;
        resultDiv.classList.remove('hidden');
      } catch (err) {
        resultDiv.innerHTML = '<span class="text-red-500 font-medium">Connection failed. Please try again.</span>';
        resultDiv.classList.remove('hidden');
      }

      submitBtn.disabled = false;
      submitBtn.innerText = 'Analyze Another Photo';
    });
  </script>
</body>

</html>